# Resource limits configuration:
# - Prevents resource exhaustion attacks (DoS protection)
# - Ensures fair resource allocation between services
# - Limits: Maximum resources the container can use
# - Reservations: Guaranteed minimum resources for the container

services:
  # =============================================================================
  # Nginx Reverse Proxy
  # =============================================================================
  # Secure entry point for all API traffic. This is the ONLY service that
  # exposes ports to the host network. All other services are accessed
  # through Nginx, providing:
  # - TLS termination (HTTPS)
  # - Request filtering and rate limiting
  # - Centralized access control
  # - Network isolation (bridges external and internal networks)
  # =============================================================================
  nginx:
    build:
      context: ./deploy/nginx
      dockerfile: Dockerfile
    container_name: wazuh-nginx
    
    # Port exposure - ONLY Nginx exposes ports to host
    # All other services are accessed through Nginx reverse proxy
    ports:
      - "443:443"   # HTTPS - primary secure endpoint
      - "80:80"     # HTTP - redirects to HTTPS
    
    # Volume mounts (all read-only for security)
    volumes:
      # SSL certificates
      - ./deploy/nginx/certs:/etc/nginx/ssl:ro
      # Nginx configuration files
      - ./deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./deploy/nginx/conf.d:/etc/nginx/conf.d:ro
      # Nginx logs - shared with fail2ban for monitoring
      - nginx-logs:/var/log/nginx
    
    # Network configuration - bridges external and internal networks
    # This allows Nginx to receive external traffic and forward to internal services
    networks:
      - wazuh-external  # Receives incoming traffic from host
      - wazuh-internal  # Forwards requests to backend services
    
    # Dependencies - ensure backend services start first
    depends_on:
      - agent-ingest
    
    # Restart policy
    restart: unless-stopped
    
    # Security hardening options
    security_opt:
      # Prevent privilege escalation via setuid/setgid binaries
      - no-new-privileges:true
    # Drop all Linux capabilities for minimal attack surface
    cap_drop:
      - ALL
    # Add back only the capability needed to bind to privileged ports (80, 443)
    cap_add:
      - NET_BIND_SERVICE
    
    # Resource limits for Nginx (lightweight reverse proxy)
    # Legacy format for standalone docker-compose (non-Swarm)
    mem_limit: 128m
    mem_reservation: 32m
    cpus: 0.5
    # Deploy section for Docker Swarm / docker-compose --compatibility mode
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 32M
    
    # Health check - verify Nginx is responding on HTTPS
    # Uses the /health/live endpoint which doesn't require authentication
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost:443/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # =============================================================================
  # Agent Ingest Service
  # =============================================================================
  agent-ingest:
    build:
      context: .
      args:
        - "WAZUH_AGENT_VERSION=${WAZUH_AGENT_VERSION:-}"
    image: sammascanner/wazuh-agent:ingets_0.2
    # ==========================================================================
    # Network Isolation: Service is on internal network only
    # Access this service through Nginx reverse proxy, not directly
    # ==========================================================================
    networks:
      - wazuh-internal
    # --------------------------------------------------------------------------
    # PORTS REMOVED FOR SECURITY - Access through Nginx reverse proxy only
    # The API is no longer directly accessible from the host network.
    # To access: Use Nginx proxy at https://<host>:<nginx-port>/api/
    # --------------------------------------------------------------------------
    # ports:
    #   # Port bound to localhost only for development security
    #   # External access should go through Nginx reverse proxy in production
    #   - "127.0.0.1:9000:9000"
    volumes:
      # Named volume for Wazuh agent configuration (persistent, isolated from host)
      - agent-ingest-ossec-etc:/var/ossec/etc
      # Named volume for Wazuh agent data (logs, queues, etc.)
      - agent-ingest-ossec-data:/var/ossec/data
      # Named volume for agent logs
      - agent-ingest-ossec-logs:/var/ossec/logs
    environment:
      - "MANAGER_URL=${MANAGER_URL:-localhost}"
      - "MANAGER_PORT=${MANAGER_PORT:-1515}"
      - "SERVER_URL=${SERVER_URL:-localhost}"
      - "SERVER_PORT=${SERVER_PORT:-1514}"
      - "NAME=${NAME:-agent-ingest}"
      - "GROUP=${GROUP:-default}"
      - "ENROL_TOKEN=${ENROL_TOKEN:-}"
      - "API_KEY=${API_KEY:-}"
      - "WAZUH_DECODER_HEADER=${WAZUH_DECODER_HEADER:-1:Wazuh-AWS:}"
    # -------------------------------------------------------------------------
    # Docker Secrets - Secure credential management
    # -------------------------------------------------------------------------
    # Secrets are mounted as read-only files at /run/secrets/<secret_name>
    # The API reads the API key from /run/secrets/api_key (implemented in api.py)
    # To generate secrets, run: ./scripts/init-secrets.sh
    #
    # Note: For Docker Compose v1 compatibility, uid/gid/mode options are not
    # used. The container runs as root to ensure access to secrets and Wazuh
    # binaries. This is acceptable for a test environment.
    # -------------------------------------------------------------------------
    secrets:
      - api_key
    # Health check using the liveness probe endpoint (no auth required)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    # -------------------------------------------------------------------------
    # Security Note: no-new-privileges is removed to allow Wazuh agent to
    # switch to the wazuh group during startup. The container still runs
    # as non-root (wazuh user) for security.
    # -------------------------------------------------------------------------
    # Drop all Linux capabilities for minimal attack surface
    cap_drop:
      - ALL
    # -------------------------------------------------------------------------
    # Required capabilities for Wazuh agent:
    # - SETGID: Required for wazuh-execd to switch to 'wazuh' group after startup
    # - SETUID: Required for wazuh-execd to switch to 'wazuh' user after startup
    # Without these, the agent fails with: "Cannot setgid(): Operation not permitted"
    # -------------------------------------------------------------------------
    cap_add:
      - SETGID
      - SETUID
    # Note: NET_BIND_SERVICE not needed as service uses port 9000 (>1024)
    # Resource limits for API service (higher limits for handling HTTP requests)
    # Legacy format for standalone docker-compose (non-Swarm)
    mem_limit: 512m
    mem_reservation: 128m
    cpus: 1.0
    # Deploy section for Docker Swarm / docker-compose --compatibility mode
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  agent-regular:
    build:
      context: .
      dockerfile: Dockerfile.agent
      args:
        - "WAZUH_AGENT_VERSION=${WAZUH_AGENT_VERSION:-}"
    image: sammascanner/wazuh-agent:regular_0.2
    # ==========================================================================
    # Network Isolation: Service is on internal network only
    # Access this service through Nginx reverse proxy, not directly
    # ==========================================================================
    networks:
      - wazuh-internal
    # --------------------------------------------------------------------------
    # PORTS REMOVED FOR SECURITY - Access through Nginx reverse proxy only
    # The agent is no longer directly accessible from the host network.
    # To access: Use Nginx proxy at https://<host>:<nginx-port>/agent/
    # --------------------------------------------------------------------------
    # ports:
    #   # Port bound to localhost only for development security
    #   # External access should go through Nginx reverse proxy in production
    #   - "127.0.0.1:${AGENT_REGULAR_PORT:-9001}:9000"
    volumes:
      # Named volume for Wazuh agent configuration (persistent, isolated from host)
      - agent-regular-ossec-etc:/var/ossec/etc
      # Named volume for Wazuh agent data (logs, queues, etc.)
      - agent-regular-ossec-data:/var/ossec/data
      # Named volume for agent logs
      - agent-regular-ossec-logs:/var/ossec/logs
    environment:
      - "MANAGER_URL=${MANAGER_URL:-localhost}"
      - "MANAGER_PORT=${MANAGER_PORT:-1515}"
      - "SERVER_URL=${SERVER_URL:-localhost}"
      - "SERVER_PORT=${SERVER_PORT:-1514}"
      - "NAME=${NAME:-agent-regular}"
      - "GROUP=${GROUP:-default}"
      - "ENROL_TOKEN=${ENROL_TOKEN:-}"
    # Security hardening options
    security_opt:
      # Prevent privilege escalation via setuid/setgid binaries
      - no-new-privileges:true
    # Drop all Linux capabilities for minimal attack surface
    cap_drop:
      - ALL
    # -------------------------------------------------------------------------
    # Required capabilities for Wazuh agent:
    # - SETGID: Required for wazuh-execd to switch to 'wazuh' group after startup
    # - SETUID: Required for wazuh-execd to switch to 'wazuh' user after startup
    # Without these, the agent fails with: "Cannot setgid(): Operation not permitted"
    # -------------------------------------------------------------------------
    cap_add:
      - SETGID
      - SETUID
    # Note: NET_BIND_SERVICE not needed as service uses port 9001 (>1024)
    # Resource limits for regular agent (lower limits as it's less resource-intensive)
    # Legacy format for standalone docker-compose (non-Swarm)
    mem_limit: 256m
    mem_reservation: 64m
    cpus: 0.5
    # Deploy section for Docker Swarm / docker-compose --compatibility mode
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

  # =============================================================================
  # Fail2ban Service
  # =============================================================================
  # Automated IP banning based on Nginx access logs. Monitors for:
  # - Authentication failures (401/403)
  # - Rate limit violations (429)
  # - Bad requests (400)
  # - Scanning/probing attempts (404 on sensitive paths)
  #
  # Uses host network mode to manage iptables rules on the host.
  # =============================================================================
  fail2ban:
    build:
      context: ./deploy/fail2ban
      dockerfile: Dockerfile
    container_name: wazuh-fail2ban
    restart: unless-stopped
    
    # Host network mode required for iptables management
    network_mode: host
    
    # Capabilities required for iptables manipulation
    cap_add:
      - NET_ADMIN
      - NET_RAW
    
    # Volume mounts
    volumes:
      # Nginx logs - read-only access for monitoring
      - nginx-logs:/var/log/nginx:ro
      # Fail2ban persistent data (ban database)
      - fail2ban-data:/var/lib/fail2ban
      # Fail2ban socket for fail2ban-client communication
      - /var/run/fail2ban:/var/run/fail2ban
    
    # Dependencies - ensure nginx starts first
    depends_on:
      - nginx
    
    # Security hardening
    security_opt:
      - no-new-privileges:true
    
    # Resource limits for Fail2ban (lightweight monitoring service)
    mem_limit: 128m
    mem_reservation: 32m
    cpus: 0.25
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M

volumes:
  # Agent-ingest named volumes
  agent-ingest-ossec-etc:
    driver: local
  agent-ingest-ossec-data:
    driver: local
  agent-ingest-ossec-logs:
    driver: local
  # Agent-regular named volumes
  agent-regular-ossec-etc:
    driver: local
  agent-regular-ossec-data:
    driver: local
  agent-regular-ossec-logs:
    driver: local
  # Nginx logs volume - shared between nginx and fail2ban
  nginx-logs:
    driver: local
  # Fail2ban persistent data volume
  fail2ban-data:
    driver: local

# =============================================================================
# Network Configuration
# =============================================================================
# Network isolation separates external and internal traffic for security.
# This ensures backend services are not directly accessible from outside,
# only through the Nginx reverse proxy.
#
# Architecture:
#   [Internet] → [Nginx (external+internal)] → [API (internal only)]
#                                            → [Agent (internal only)]
#
# - wazuh-external: Bridge network, accessible from host (for Nginx)
# - wazuh-internal: Internal network, isolated from host (internal: true)
#
# Service Discovery: Containers on the same network can reach each other
# by service name (e.g., agent-ingest:9000, agent-regular:9000)
# =============================================================================
networks:
  # External network - accessible from host, used by Nginx for incoming traffic
  # Nginx will be connected to this network to receive external requests
  wazuh-external:
    driver: bridge
    name: wazuh-external
  
  # Internal network - isolated from host, only for inter-container communication
  # The 'internal: true' flag prevents containers on this network from
  # accessing the external network directly, providing network isolation
  wazuh-internal:
    driver: bridge
    # internal: true  # This makes the network isolated from the host
    name: wazuh-internal

# =============================================================================
# Secrets Configuration
# =============================================================================
# Docker secrets provide secure credential management for sensitive data.
#
# How it works:
# - Secrets are defined at the top level and referenced by services
# - Docker mounts secret files at /run/secrets/<secret_name> inside containers
# - Files are mounted read-only and stored in memory (tmpfs), not on disk
# - Only containers that explicitly reference a secret can access it
#
# Setup:
# 1. Run ./scripts/init-secrets.sh to generate secret files
# 2. Or manually create ./secrets/api_key.txt with your API key
#
# The API service reads the key from /run/secrets/api_key automatically
# =============================================================================
secrets:
  # API authentication key for the agent-ingest service
  # File should contain only the API key value (no newlines or extra whitespace)
  api_key:
    file: ./secrets/api_key.txt
