# Container Vulnerability Scanning

## Overview

This document describes the vulnerability scanning process for container images in the Wazuh Log Pipeline project. Vulnerability scanning is a critical security practice that identifies known security issues in container images before deployment.

## Tools

### Trivy

We use **Trivy** by Aqua Security for vulnerability scanning. Trivy is an open-source, comprehensive security scanner that detects:

- **OS package vulnerabilities** (Alpine, RHEL, CentOS, Debian, Ubuntu, etc.)
- **Application dependencies** (Python, Node.js, Ruby, PHP, etc.)
- **Infrastructure as Code (IaC) misconfigurations**
- **Sensitive information and secrets**

## Usage

### Basic Usage

```bash
./scripts/scan-image.sh <image-name:tag> [format]
```

### Examples

```bash
# Scan with default settings (table output)
./scripts/scan-image.sh wazuh-api:latest

# Scan with JSON output for CI/CD integration
./scripts/scan-image.sh wazuh-api:latest json

# Scan with SARIF output for GitHub Security tab
./scripts/scan-image.sh wazuh-api:latest sarif
```

### Output Formats

| Format | Use Case |
|--------|----------|
| `table` | Human-readable console output (default) |
| `json` | Machine-readable for CI/CD pipelines |
| `sarif` | GitHub Security tab integration |

## Severity Levels

Vulnerabilities are classified by severity:

| Severity | Description | Action Required |
|----------|-------------|-----------------|
| **CRITICAL** | Exploitable vulnerabilities with severe impact | Must be fixed before deployment |
| **HIGH** | Significant vulnerabilities | Should be fixed as soon as possible |
| **MEDIUM** | Moderate risk vulnerabilities | Should be addressed in regular maintenance |
| **LOW** | Minor vulnerabilities | Can be addressed in future updates |

### Default Configuration

The scanner is configured to:
- Report **CRITICAL** and **HIGH** severity vulnerabilities
- Exit with error code 1 if vulnerabilities are found
- Save reports to `./reports/security/`

## Remediation Process

When vulnerabilities are found, follow this process:

### 1. Review Scan Report

Examine the scan output to understand:
- Which packages are affected
- The CVE identifiers
- Available fixed versions

### 2. Identify Affected Packages

```bash
# View detailed vulnerability information
trivy image --severity CRITICAL,HIGH --format json wazuh-api:latest | jq '.Results[].Vulnerabilities[]'
```

### 3. Update Base Image or Packages

**Option A: Update Base Image**
```dockerfile
# Update to a newer base image with patches
FROM python:3.11-slim-bookworm
```

**Option B: Update Specific Packages**
```dockerfile
# Add package updates in Dockerfile
RUN apt-get update && apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
    package-name=fixed-version && \
    rm -rf /var/lib/apt/lists/*
```

### 4. Rebuild and Rescan

```bash
# Rebuild the image
docker build -t wazuh-api:latest .

# Rescan to verify fixes
./scripts/scan-image.sh wazuh-api:latest
```

### 5. Document Exceptions

If a vulnerability cannot be fixed immediately, document it:

```markdown
## Vulnerability Exception: CVE-XXXX-XXXXX

- **Package**: package-name
- **Severity**: HIGH
- **Reason for Exception**: No fix available / False positive / Mitigated by other controls
- **Mitigation**: Description of compensating controls
- **Review Date**: YYYY-MM-DD
```

## CI/CD Integration

### GitHub Actions

```yaml
name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build image
        run: docker build -t wazuh-api:${{ github.sha }} .
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'wazuh-api:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
      
      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
```

### GitLab CI

```yaml
container_scanning:
  stage: test
  image: docker:stable
  services:
    - docker:dind
  script:
    - docker build -t wazuh-api:$CI_COMMIT_SHA .
    - ./scripts/scan-image.sh wazuh-api:$CI_COMMIT_SHA json
  artifacts:
    paths:
      - reports/security/
    reports:
      container_scanning: reports/security/*.json
```

### Jenkins Pipeline

```groovy
pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                sh 'docker build -t wazuh-api:${BUILD_NUMBER} .'
            }
        }
        stage('Security Scan') {
            steps {
                sh './scripts/scan-image.sh wazuh-api:${BUILD_NUMBER} json'
            }
            post {
                always {
                    archiveArtifacts artifacts: 'reports/security/*.json'
                }
            }
        }
    }
}
```

## Best Practices

### 1. Scan Early and Often

- Scan images during development, not just before deployment
- Include scanning in CI/CD pipelines
- Scan base images before building

### 2. Keep Base Images Updated

```bash
# Check for base image updates
docker pull python:3.11-slim-bookworm
```

### 3. Use Minimal Base Images

Prefer distroless or slim images to reduce attack surface:
- `python:3.11-slim-bookworm` instead of `python:3.11`
- `gcr.io/distroless/python3` for production

### 4. Pin Package Versions

```dockerfile
# Pin versions for reproducibility
RUN pip install --no-cache-dir \
    flask==3.0.0 \
    gunicorn==21.2.0
```

### 5. Regular Scanning Schedule

Set up scheduled scans for deployed images:

```bash
# Cron job for weekly scans
0 0 * * 0 /path/to/scripts/scan-image.sh wazuh-api:production json
```

## Troubleshooting

### Common Issues

**Issue: Trivy cannot access Docker socket**
```bash
# Ensure Docker socket is accessible
sudo chmod 666 /var/run/docker.sock
# Or run with sudo
sudo ./scripts/scan-image.sh wazuh-api:latest
```

**Issue: Image not found**
```bash
# Ensure image exists locally
docker images | grep wazuh-api
# Or pull from registry
docker pull registry.example.com/wazuh-api:latest
```

**Issue: Network timeout**
```bash
# Trivy needs to download vulnerability database
# Ensure network connectivity or use offline mode
trivy image --download-db-only
```

## References

- [Trivy Documentation](https://aquasecurity.github.io/trivy/)
- [CVE Database](https://cve.mitre.org/)
- [NVD - National Vulnerability Database](https://nvd.nist.gov/)
- [Docker Security Best Practices](https://docs.docker.com/develop/security-best-practices/)