# =============================================================================
# IP Whitelist Configuration for Wazuh Log Ingestion API
# Allows trusted IPs to bypass rate limiting
# =============================================================================
# This configuration uses Nginx's geo and map modules to identify trusted IPs
# and provide them with a bypass mechanism for rate limiting.
#
# How it works:
# 1. The geo block checks if the client IP is in the whitelist
# 2. The map block converts the whitelist status to a rate limit key
# 3. Whitelisted IPs get an empty key (bypasses rate limit)
# 4. Non-whitelisted IPs use their IP address as the key (subject to rate limit)
# =============================================================================

# -----------------------------------------------------------------------------
# Geo Block: Identify Whitelisted IPs
# -----------------------------------------------------------------------------
# Returns 1 for whitelisted IPs, 0 for all others
# The geo module is efficient for IP-based lookups and supports CIDR notation
# -----------------------------------------------------------------------------
geo $whitelist {
    # Default: not whitelisted
    default 0;
    
    # -------------------------------------------------------------------------
    # Localhost
    # -------------------------------------------------------------------------
    # Always trust localhost connections
    127.0.0.1 1;
    ::1 1;
    
    # -------------------------------------------------------------------------
    # Private Network Ranges (RFC 1918)
    # -------------------------------------------------------------------------
    # These are internal network addresses that cannot be routed on the internet
    # Typically used for internal services and trusted infrastructure
    
    # Class A private network (10.0.0.0 - 10.255.255.255)
    10.0.0.0/8 1;
    
    # Class B private network (172.16.0.0 - 172.31.255.255)
    172.16.0.0/12 1;
    
    # Class C private network (192.168.0.0 - 192.168.255.255)
    192.168.0.0/16 1;
    
    # -------------------------------------------------------------------------
    # Docker Internal Networks
    # -------------------------------------------------------------------------
    # Default Docker bridge networks
    # These ranges are used by Docker for container-to-container communication
    172.17.0.0/16 1;
    172.18.0.0/16 1;
    172.19.0.0/16 1;
    172.20.0.0/16 1;
    
    # -------------------------------------------------------------------------
    # Trusted External IPs
    # -------------------------------------------------------------------------
    # Add trusted external IP addresses below
    # Use CIDR notation for ranges or single IPs
    # Examples:
    #   203.0.113.50 1;        # Single IP
    #   198.51.100.0/24 1;     # IP range (256 addresses)
    #
    # IMPORTANT: Document the purpose of each trusted IP for audit purposes
    # Format: <IP/CIDR> 1;  # <Description> - Added <Date> by <Admin>
    # -------------------------------------------------------------------------
    
    # === ADD TRUSTED EXTERNAL IPs BELOW THIS LINE ===
    
    # === END TRUSTED EXTERNAL IPs ===
}

# -----------------------------------------------------------------------------
# Map Block: Convert Whitelist Status to Rate Limit Key
# -----------------------------------------------------------------------------
# This map converts the whitelist status ($whitelist) to a rate limit key
# - Whitelisted IPs (whitelist=1): Get empty key "" which bypasses rate limiting
# - Non-whitelisted IPs (whitelist=0): Use their IP address as the key
#
# The $limit_key variable is used in rate-limiting.conf for the limit_req_zone
# -----------------------------------------------------------------------------
map $whitelist $limit_key {
    # Non-whitelisted: use binary IP address as rate limit key
    0 $binary_remote_addr;
    
    # Whitelisted: empty key bypasses rate limiting
    # (limit_req_zone ignores requests with empty keys)
    1 "";
}