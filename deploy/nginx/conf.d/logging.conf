# =============================================================================
# Nginx Security Logging Configuration
# =============================================================================
# JSON format for easy parsing and SIEM integration
# This configuration provides security-focused logging with fields optimized
# for security monitoring, forensics, and correlation with API logs.
# =============================================================================

# -----------------------------------------------------------------------------
# Security-Focused JSON Log Format
# -----------------------------------------------------------------------------
# Comprehensive logging format that captures all security-relevant fields
# Note: API keys should never be logged - they are handled by the API layer
# 
# Fields included:
# - timestamp: ISO 8601 format for easy correlation
# - remote_addr: Client IP for security analysis
# - x_forwarded_for: Original client IP if behind proxy/CDN
# - request_method: HTTP method (GET, POST, etc.)
# - request_uri: Requested path (without query string for security)
# - server_protocol: HTTP version used
# - status: HTTP response code
# - body_bytes_sent: Response size
# - request_time: Total request processing time
# - upstream_response_time: Backend API response time
# - upstream_addr: Backend server that handled the request
# - http_referer: Referrer header
# - http_user_agent: User agent for client identification
# - http_x_request_id: Request ID for log correlation with API
# - ssl_protocol: TLS version used (security auditing)
# - ssl_cipher: Cipher suite used (security auditing)
# - request_length: Request size (for anomaly detection)
# - connection: Connection serial number
# - connection_requests: Requests on this connection (keep-alive tracking)
# - limit_req_status: Rate limiting status (abuse detection)
# -----------------------------------------------------------------------------

log_format security_json escape=json '{'
    '"timestamp":"$time_iso8601",'
    '"remote_addr":"$remote_addr",'
    '"x_forwarded_for":"$http_x_forwarded_for",'
    '"request_method":"$request_method",'
    '"request_uri":"$request_uri",'
    '"server_protocol":"$server_protocol",'
    '"status":$status,'
    '"body_bytes_sent":$body_bytes_sent,'
    '"request_time":$request_time,'
    '"upstream_response_time":"$upstream_response_time",'
    '"upstream_addr":"$upstream_addr",'
    '"http_referer":"$http_referer",'
    '"http_user_agent":"$http_user_agent",'
    '"http_x_request_id":"$http_x_request_id",'
    '"ssl_protocol":"$ssl_protocol",'
    '"ssl_cipher":"$ssl_cipher",'
    '"request_length":$request_length,'
    '"connection":$connection,'
    '"connection_requests":$connection_requests,'
    '"limit_req_status":"$limit_req_status"'
'}';

# -----------------------------------------------------------------------------
# Standard Combined Format with Security Extensions (Fallback)
# -----------------------------------------------------------------------------
# Enhanced combined format with timing information for performance analysis
# Use this format when JSON parsing is not available
# -----------------------------------------------------------------------------

log_format combined_security '$remote_addr - $remote_user [$time_local] '
    '"$request" $status $body_bytes_sent '
    '"$http_referer" "$http_user_agent" '
    'rt=$request_time uct="$upstream_connect_time" '
    'uht="$upstream_header_time" urt="$upstream_response_time" '
    'ssl="$ssl_protocol/$ssl_cipher" rid="$http_x_request_id"';

# -----------------------------------------------------------------------------
# Conditional Logging Map
# -----------------------------------------------------------------------------
# Controls which requests are logged
# Set $loggable to 0 for paths that should not be logged
# Usage: access_log /path/to/log security_json if=$loggable;
# -----------------------------------------------------------------------------

map $request_uri $loggable {
    # Log ALL requests including health checks
    # Health check logging is essential for:
    # - Detecting abuse patterns (rate limit exhaustion attacks)
    # - Security forensics
    # - Fail2ban detection of malicious health endpoint abuse
    # The volume of legitimate health checks is typically low
    default 1;
}

# -----------------------------------------------------------------------------
# Log Format Selection Map
# -----------------------------------------------------------------------------
# Allows dynamic selection of log format based on conditions
# Can be extended for different logging needs per endpoint
# -----------------------------------------------------------------------------

map $request_uri $log_format_type {
    default "security_json";
}

# -----------------------------------------------------------------------------
# Default Access Log Configuration
# -----------------------------------------------------------------------------
# Primary access log using security JSON format
# This can be overridden in server blocks for specific needs
# -----------------------------------------------------------------------------

# Note: The actual access_log directive should be in server blocks
# to allow per-vhost configuration. This file defines the formats.

# Example usage in server blocks:
# access_log /var/log/nginx/access.log security_json;
# access_log /var/log/nginx/access.log security_json if=$loggable;

# -----------------------------------------------------------------------------
# Error Log Configuration Notes
# -----------------------------------------------------------------------------
# Error log levels (from most to least verbose):
# - debug: Debugging messages (very verbose, use only for troubleshooting)
# - info: Informational messages
# - notice: Normal but significant conditions
# - warn: Warning conditions (recommended for production)
# - error: Error conditions
# - crit: Critical conditions
# - alert: Action must be taken immediately
# - emerg: System is unusable
#
# Recommended: Use 'warn' level for production environments
# error_log /var/log/nginx/error.log warn;
# -----------------------------------------------------------------------------