# =============================================================================
# Rate Limiting Configuration for Wazuh Log Ingestion API
# Protects the API from abuse and DoS attacks
# =============================================================================
# This configuration works in conjunction with ip-whitelist.conf which defines
# the $limit_key variable. Whitelisted IPs receive an empty $limit_key which
# causes them to bypass rate limiting entirely.
# =============================================================================

# -----------------------------------------------------------------------------
# Rate Limit Zone Definition
# -----------------------------------------------------------------------------
# Global rate limit zone using $limit_key from ip-whitelist.conf
# - $limit_key: Either $binary_remote_addr (for non-whitelisted IPs) or ""
#   (empty string for whitelisted IPs, which bypasses rate limiting)
# - zone=api_limit:10m: 10MB shared memory zone named "api_limit"
#   (10MB can hold ~160,000 IPv4 addresses or ~80,000 IPv6 addresses)
# - rate=100r/s: Maximum 100 requests per second per IP address
#
# NOTE: This file MUST be loaded AFTER ip-whitelist.conf to ensure $limit_key
# is defined before use.
# -----------------------------------------------------------------------------
limit_req_zone $limit_key zone=api_limit:10m rate=100r/s;

# -----------------------------------------------------------------------------
# Health Endpoint Rate Limit Zone
# -----------------------------------------------------------------------------
# Separate zone for health endpoints - isolated from API rate limits
# This prevents attackers from exhausting API rate limits via unauthenticated health checks
# - zone=health_limit:1m: 1MB shared memory zone (sufficient for health endpoint tracking)
# - rate=10r/s: More restrictive rate for health endpoints
# -----------------------------------------------------------------------------
limit_req_zone $limit_key zone=health_limit:1m rate=10r/s;

# -----------------------------------------------------------------------------
# Rate Limit Response Configuration
# -----------------------------------------------------------------------------
# Return 429 Too Many Requests when rate limit is exceeded
# (Default is 503 Service Unavailable, but 429 is more semantically correct)
limit_req_status 429;

# -----------------------------------------------------------------------------
# Rate Limit Logging Configuration
# -----------------------------------------------------------------------------
# Log rate-limited requests at warn level for monitoring and alerting
# Levels: info, notice, warn, error
# Using 'warn' to ensure visibility without excessive logging
limit_req_log_level warn;