# =============================================================================
# Server Block Configuration for Wazuh Log Ingestion API
# Handles HTTP to HTTPS redirect and API proxying
# =============================================================================

# -----------------------------------------------------------------------------
# HTTP Server - Redirect all traffic to HTTPS
# -----------------------------------------------------------------------------
server {
    listen 80;
    listen [::]:80;
    server_name _;
    
    # Redirect all HTTP requests to HTTPS
    return 301 https://$host$request_uri;
}

# -----------------------------------------------------------------------------
# HTTPS Server - Main API endpoint
# -----------------------------------------------------------------------------
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name _;
    
    # SSL configuration is included from ssl.conf via nginx.conf
    
    # -------------------------------------------------------------------------
    # IP-Based Access Control
    # -------------------------------------------------------------------------
    # Block non-whitelisted IPs with 403 Forbidden
    # The $access_denied variable is set in ip-whitelist.conf
    # Only IPs defined in the whitelist (localhost, 10.47.5.216, Docker networks,
    # and private networks) are allowed to access the API
    # -------------------------------------------------------------------------
    if ($access_denied) {
        return 403;
    }
    
    # -------------------------------------------------------------------------
    # Security Logging Configuration
    # -------------------------------------------------------------------------
    # Using security_json format for structured logging and SIEM integration
    # The security_json format includes:
    # - ISO 8601 timestamps for correlation
    # - SSL/TLS protocol and cipher information
    # - Rate limiting status for abuse detection
    # - Request ID for correlation with API logs
    # - Connection info for DDoS analysis
    # -------------------------------------------------------------------------
    access_log /var/log/nginx/api_access.log security_json;
    error_log /var/log/nginx/api_error.log warn;
    
    # ---------------------------------------------------------------------
    # Health Check Endpoint
    # Limited access for monitoring systems
    # Uses separate rate limit zone to prevent abuse affecting API limits
    # ---------------------------------------------------------------------
    location /health {
        # Rate limiting: 10 req/s with burst of 5 for health checks
        # Uses isolated health_limit zone to prevent attackers from
        # exhausting API rate limits via unauthenticated health endpoints
        limit_req zone=health_limit burst=5 nodelay;
        
        # Proxy to backend health endpoint
        proxy_pass http://wazuh-api/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts for health checks
        proxy_connect_timeout 5s;
        proxy_read_timeout 10s;
        proxy_send_timeout 5s;
    }
    
    location /health/live {
        limit_req zone=health_limit burst=5 nodelay;
        proxy_pass http://wazuh-api/health/live;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 5s;
        proxy_read_timeout 10s;
        proxy_send_timeout 5s;
    }
    
    location /health/ready {
        limit_req zone=health_limit burst=5 nodelay;
        proxy_pass http://wazuh-api/health/ready;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 5s;
        proxy_read_timeout 10s;
        proxy_send_timeout 5s;
    }
    
    # ---------------------------------------------------------------------
    # API Ingest Endpoint (Specific route for /api/ingest)
    # Must be defined BEFORE the general /api/ location block
    # ---------------------------------------------------------------------
    location = /api/ingest {
        # Rate limiting: 100 req/s with burst of 50 for log ingestion
        limit_req zone=api_limit burst=50 nodelay;
        
        # Proxy to backend ingest endpoint (strip /api prefix)
        proxy_pass http://wazuh-api/ingest;
        proxy_http_version 1.1;
        
        # Preserve original host and client information
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Pass through API key header for authentication
        proxy_set_header X-API-Key $http_x_api_key;
        
        # Longer timeout for log ingestion (matches /ingest endpoint)
        proxy_connect_timeout 30s;
        proxy_read_timeout 120s;
        proxy_send_timeout 60s;
        
        # Aligned with API MAX_CONTENT_LENGTH_INGEST (1MB)
        # Prevents resource exhaustion from large payloads that would be rejected by API anyway
        client_max_body_size 1m;
    }
    
    # ---------------------------------------------------------------------
    # API Endpoints
    # Main API proxy configuration
    # ---------------------------------------------------------------------
    location /api/ {
        # Rate limiting: 100 req/s with burst of 50 for API requests
        limit_req zone=api_limit burst=50 nodelay;
        
        # Proxy to backend API
        proxy_pass http://wazuh-api/;
        proxy_http_version 1.1;
        
        # Preserve original host and client information
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket support (if needed)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Timeouts
        proxy_connect_timeout 30s;
        proxy_read_timeout 60s;
        proxy_send_timeout 30s;
        
        # Buffer settings
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
    
    # ---------------------------------------------------------------------
    # Ingest Endpoint (Direct path for log ingestion)
    # ---------------------------------------------------------------------
    location /ingest {
        # Rate limiting: 100 req/s with burst of 50 for log ingestion
        limit_req zone=api_limit burst=50 nodelay;
        
        proxy_pass http://wazuh-api/ingest;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Longer timeout for log ingestion
        proxy_connect_timeout 30s;
        proxy_read_timeout 120s;
        proxy_send_timeout 60s;
        
        # Aligned with API MAX_CONTENT_LENGTH_INGEST (1MB)
        # Prevents resource exhaustion from large payloads that would be rejected by API anyway
        client_max_body_size 1m;
    }
    
    # ---------------------------------------------------------------------
    # Batch Endpoint (Batch log ingestion)
    # ---------------------------------------------------------------------
    location /batch {
        # Rate limiting: 100 req/s with burst of 50 for batch ingestion
        limit_req zone=api_limit burst=50 nodelay;
        
        proxy_pass http://wazuh-api/batch;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Longer timeout for batch ingestion
        proxy_connect_timeout 30s;
        proxy_read_timeout 180s;
        proxy_send_timeout 60s;
        
        # Aligned with API MAX_CONTENT_LENGTH_BATCH (10MB)
        client_max_body_size 10m;
    }
    
    # ---------------------------------------------------------------------
    # Deny access to hidden files
    # ---------------------------------------------------------------------
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # ---------------------------------------------------------------------
    # Default location - return 404
    # ---------------------------------------------------------------------
    location / {
        return 404;
    }
}
