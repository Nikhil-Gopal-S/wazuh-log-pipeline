# =============================================================================
# Nginx Main Configuration for Wazuh Log Ingestion API
# =============================================================================
# This configuration provides a security-hardened reverse proxy setup.
# Security features include:
# - Hidden server version information
# - Security headers to prevent common attacks
# - Timeout settings to mitigate slow HTTP attacks
# - Buffer size limits to prevent overflow attacks
# - Rate limiting support (configured in separate files)
# =============================================================================

# -----------------------------------------------------------------------------
# Worker Configuration
# -----------------------------------------------------------------------------
# Run as nginx user (created in Dockerfile for non-root operation)
user nginx;

# Auto-detect number of CPU cores for optimal performance
# This allows nginx to scale with the available hardware
worker_processes auto;

# Error log location and level
# Levels: debug, info, notice, warn, error, crit, alert, emerg
# Using 'warn' for production to capture important issues without excessive logging
error_log /var/log/nginx/error.log warn;

# PID file location (must be writable by nginx user)
# This path is created and owned by nginx user in the Dockerfile
pid /var/run/nginx/nginx.pid;

# -----------------------------------------------------------------------------
# Events Block
# -----------------------------------------------------------------------------
# Configure connection processing behavior
events {
    # Maximum number of simultaneous connections per worker process
    # Total connections = worker_processes * worker_connections
    worker_connections 1024;
    
    # Use epoll for efficient connection processing on Linux
    # epoll is more efficient than select/poll for high connection counts
    use epoll;
    
    # Accept multiple connections at once when notified of new connections
    # Improves performance under high load
    multi_accept on;
}

# -----------------------------------------------------------------------------
# HTTP Block
# -----------------------------------------------------------------------------
http {
    # -------------------------------------------------------------------------
    # Basic Settings
    # -------------------------------------------------------------------------
    # Include MIME type definitions for proper content handling
    include /etc/nginx/mime.types;
    
    # Default MIME type for files without a recognized extension
    default_type application/octet-stream;

    # -------------------------------------------------------------------------
    # Security Settings
    # -------------------------------------------------------------------------
    
    # SECURITY: Hide nginx version in error pages and Server header
    # Prevents attackers from identifying specific nginx vulnerabilities
    server_tokens off;
    
    # SECURITY: Prevent clickjacking attacks
    # SAMEORIGIN allows framing only from the same origin
    # Use "DENY" if framing should never be allowed
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # SECURITY: Prevent MIME type sniffing
    # Stops browsers from trying to guess the MIME type
    # Reduces risk of drive-by download attacks
    add_header X-Content-Type-Options "nosniff" always;
    
    # SECURITY: Enable XSS filter in browsers
    # Provides additional protection against cross-site scripting
    # mode=block prevents rendering if attack is detected
    add_header X-XSS-Protection "1; mode=block" always;
    
    # SECURITY: Referrer Policy
    # Controls how much referrer information is sent with requests
    # strict-origin-when-cross-origin sends full URL for same-origin,
    # only origin for cross-origin, nothing for downgrade
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # SECURITY: Content Security Policy - defense in depth for API responses
    # Even though this is an API (not serving HTML), CSP provides additional protection
    # default-src 'none' - blocks all content loading by default
    # frame-ancestors 'none' - prevents embedding in iframes (similar to X-Frame-Options)
    # form-action 'none' - prevents form submissions
    add_header Content-Security-Policy "default-src 'none'; frame-ancestors 'none'; form-action 'none'" always;

    # -------------------------------------------------------------------------
    # Logging Configuration
    # -------------------------------------------------------------------------
    # Security-focused logging is configured in a separate file for maintainability
    # Includes: security_json format, combined_security format, conditional logging
    # -------------------------------------------------------------------------
    
    # Include security logging configuration (log formats and maps)
    # Must be included before any access_log directives that use these formats
    include /etc/nginx/conf.d/logging.conf;
    
    # Default access log using security JSON format
    # Individual server blocks can override this with their own access_log directives
    access_log /var/log/nginx/access.log security_json;

    # -------------------------------------------------------------------------
    # Performance Settings
    # -------------------------------------------------------------------------
    
    # Enable sendfile for efficient file serving
    # Uses kernel-level file transfer, bypassing user space
    sendfile on;
    
    # Optimize packet sending by waiting for full packets
    # Works with sendfile to reduce network overhead
    tcp_nopush on;
    
    # Disable Nagle's algorithm for real-time applications
    # Reduces latency for small packets (like API responses)
    tcp_nodelay on;

    # -------------------------------------------------------------------------
    # Timeout Settings (Security: Prevent Slow HTTP Attacks)
    # -------------------------------------------------------------------------
    
    # Time to keep idle connections open
    # Balance between performance (reuse connections) and resource usage
    keepalive_timeout 65;
    
    # SECURITY: Maximum time to receive client request body
    # Prevents slow POST attacks (Slowloris variant)
    client_body_timeout 10;
    
    # SECURITY: Maximum time to receive client request headers
    # Prevents slow header attacks (Slowloris)
    client_header_timeout 10;
    
    # SECURITY: Maximum time for transmitting response to client
    # Prevents slow read attacks
    send_timeout 10;
    
    # Reset timed out connections to free up resources
    reset_timedout_connection on;

    # -------------------------------------------------------------------------
    # Buffer Size Settings (Security: Prevent Buffer Overflow Attacks)
    # -------------------------------------------------------------------------
    
    # SECURITY: Buffer size for reading client request body
    # Requests larger than this are written to temporary files
    # 16k is sufficient for most API requests
    client_body_buffer_size 16k;
    
    # SECURITY: Buffer size for reading client request headers
    # 1k is sufficient for normal headers
    client_header_buffer_size 1k;
    
    # SECURITY: Maximum allowed size of client request body
    # Prevents large payload attacks; adjust based on expected log sizes
    # 10m allows for batch log submissions
    client_max_body_size 10m;
    
    # SECURITY: Buffers for large client headers (cookies, etc.)
    # 4 buffers of 8k each for handling large headers
    large_client_header_buffers 4 8k;

    # -------------------------------------------------------------------------
    # Gzip Compression (Performance)
    # -------------------------------------------------------------------------
    
    # Enable gzip compression for responses
    gzip on;
    
    # Add Vary: Accept-Encoding header for proper caching
    gzip_vary on;
    
    # Minimum response size to compress (smaller responses not worth it)
    gzip_min_length 1024;
    
    # Compression level (1-9, higher = more compression but more CPU)
    # Level 6 provides good balance between compression and CPU usage
    gzip_comp_level 6;
    
    # MIME types to compress
    # Only compress text-based content that benefits from compression
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml
        application/xml+rss
        application/x-javascript;
    
    # Disable gzip for old IE versions that don't handle it well
    gzip_disable "msie6";

    # -------------------------------------------------------------------------
    # Upstream Configuration
    # -------------------------------------------------------------------------
    
    # Define upstream server pool for the Wazuh API service
    # This allows for load balancing and connection pooling
    upstream wazuh-api {
        # Backend API server (agent-ingest container on port 9000)
        server agent-ingest:9000;
        
        # Keep connections alive to backend for better performance
        # Reduces connection establishment overhead
        keepalive 32;
    }

    # -------------------------------------------------------------------------
    # Include Additional Configuration Files
    # -------------------------------------------------------------------------
    # IMPORTANT: Load order matters! Files are loaded in the order specified.
    # Dependencies:
    # 1. ssl.conf - SSL/TLS settings (no dependencies)
    # 2. ip-whitelist.conf - Defines $whitelist and $limit_key variables
    # 3. rate-limiting.conf - Uses $limit_key from ip-whitelist.conf
    # 4. default.conf - Server blocks that use rate limit zones
    # -------------------------------------------------------------------------
    
    # Include SSL/TLS configuration (certificates, protocols, ciphers)
    include /etc/nginx/conf.d/ssl.conf;
    
    # Cloudflare Real IP Configuration
    # Must be loaded before ip-whitelist to ensure we block the real IP, not Cloudflare
    include /etc/nginx/conf.d/cloudflare_real_ip.conf;
    
    # Include IP whitelist configuration (must be before rate-limiting.conf)
    # Defines geo block for whitelisted IPs and map for $limit_key variable
    include /etc/nginx/conf.d/ip-whitelist.conf;
    
    # Include rate limiting configuration (must be after ip-whitelist.conf)
    # Uses $limit_key variable to allow whitelisted IPs to bypass rate limits
    include /etc/nginx/conf.d/rate-limiting.conf;
    
    # Include all server block configurations
    # This includes the main API server block and any additional configs
    include /etc/nginx/conf.d/default.conf;
}