# =============================================================================
# Fail2ban Filter: Scanner/Probe Detection (404 on attack paths)
# =============================================================================
# Detects automated scanners probing for common vulnerabilities
# Matches Nginx JSON log format (security_json from logging.conf)
#
# This filter catches requests to paths commonly targeted by:
# - WordPress scanners
# - PHP vulnerability scanners
# - Configuration file hunters
# - Admin panel finders
# - Cloud credential harvesters
#
# JSON log example:
# {"timestamp":"2026-01-29T10:00:00Z","remote_addr":"192.168.1.100",
#  "request_method":"GET","request_uri":"/wp-admin","status":404,...}
# =============================================================================

[Definition]

# Match 404 responses on common attack paths
# Expanded list includes:
# - CMS admin panels (wp-admin, phpmyadmin, admin)
# - Configuration files (.env, .git, config, .htaccess)
# - Shell/command injection paths (shell, cmd, exec, cgi-bin)
# - API documentation (swagger, graphql, actuator)
# - Cloud credentials (.aws, .ssh, id_rsa)
# - Debug/management endpoints (debug, console, manager, status)
# - Common vulnerability paths (xmlrpc, .well-known)
failregex = ^.*"remote_addr":"<HOST>".*"request_uri":"/(admin|wp-admin|wp-login|phpmyadmin|pma|\.env|\.git|\.svn|\.htaccess|config|backup|shell|cmd|exec|cgi-bin|scripts|actuator|swagger|swagger-ui|api-docs|graphql|\.aws|\.ssh|id_rsa|debug|console|manager|status|server-status|\.well-known/security\.txt|xmlrpc\.php|wp-content|wp-includes|vendor|node_modules|\.DS_Store|\.vscode|\.idea)[^"]*".*"status":\s*404\b.*$

# Ignore legitimate security.txt requests (if you have one)
ignoreregex =

# Date pattern for ISO 8601 timestamps in JSON logs
datepattern = "timestamp":"%%Y-%%m-%%dT%%H:%%M:%%S